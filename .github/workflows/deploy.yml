name: ğŸš€ Deploy AutomÃ¡tico via SSH

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy para Cloud Panel
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¦ Checkout do CÃ³digo
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: ğŸ“¥ Instalar DependÃªncias
        run: npm ci
      
      - name: ğŸ—ï¸ Build do Projeto
        run: npm run build
        
      - name: ğŸ” Verificar Build
        run: |
          if [ ! -d "dist" ]; then
            echo "âŒ Erro: Pasta dist nÃ£o foi gerada!"
            exit 1
          fi
          echo "âœ… Build gerado com sucesso!"
      
      - name: ğŸš€ Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            echo "ğŸš€ Iniciando deploy do tgoo-auth-backend..."
            
            # Definir diretÃ³rio do projeto
            PROJECT_DIR="${{ secrets.PROJECT_PATH }}"
            
            # Verificar se o diretÃ³rio existe
            if [ ! -d "$PROJECT_DIR" ]; then
              echo "âŒ Erro: DiretÃ³rio $PROJECT_DIR nÃ£o encontrado!"
              exit 1
            fi
            
            # Navegar para o diretÃ³rio
            cd "$PROJECT_DIR"
            
            # Backup do .env
            if [ -f .env ]; then
              cp .env .env.backup
              echo "âœ… Backup do .env criado"
            fi
            
            # Atualizar cÃ³digo do repositÃ³rio
            echo "ğŸ“¦ Atualizando cÃ³digo..."
            git fetch origin
            git reset --hard origin/${{ github.ref_name }}
            
            # Restaurar .env
            if [ -f .env.backup ]; then
              mv .env.backup .env
              echo "âœ… .env restaurado"
            fi
            
            # Instalar dependÃªncias
            echo "ğŸ“¥ Instalando dependÃªncias..."
            npm ci --production
            
            # Gerar Prisma Client
            echo "ğŸ”§ Gerando Prisma Client..."
            npx prisma generate
            
            # Executar migrations
            echo "ğŸ—ƒï¸ Executando migrations do banco de dados..."
            npx prisma migrate deploy
            
            # Build do projeto
            echo "ğŸ—ï¸ Fazendo build..."
            npm run build
            
            # Verificar se PM2 estÃ¡ instalado
            if ! command -v pm2 &> /dev/null; then
              echo "âš ï¸ PM2 nÃ£o encontrado, instalando..."
              npm install -g pm2
            fi
            
            # Reiniciar aplicaÃ§Ã£o com PM2
            echo "ğŸ”„ Reiniciando aplicaÃ§Ã£o..."
            if pm2 list | grep -q "tgoo-auth-backend"; then
              pm2 restart tgoo-auth-backend
              echo "âœ… AplicaÃ§Ã£o reiniciada"
            else
              pm2 start ecosystem.config.js
              pm2 save
              echo "âœ… AplicaÃ§Ã£o iniciada"
            fi
            
            # Mostrar status
            echo "ğŸ“Š Status da aplicaÃ§Ã£o:"
            pm2 status tgoo-auth-backend
            
            echo "ğŸ‰ Deploy concluÃ­do com sucesso!"
      
      - name: âœ… NotificaÃ§Ã£o de Sucesso
        if: success()
        run: |
          echo "âœ… Deploy realizado com sucesso!"
          echo "ğŸ“ Branch: ${{ github.ref_name }}"
          echo "ğŸ“¦ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Por: ${{ github.actor }}"
      
      - name: âŒ NotificaÃ§Ã£o de Falha
        if: failure()
        run: |
          echo "âŒ Deploy falhou!"
          echo "ğŸ” Verifique os logs acima para mais detalhes"
